# abnb_pandas_lab.py
# ----------------------------------------------
# Airbnb ì£¼ê°€ CSVë¡œ pandas ì‹¤ìŠµ ì˜¬ì¸ì› ìŠ¤í¬ë¦½íŠ¸
# ê¸°ëŠ¥:
# 1) CSV ë¡œë“œ & ì ê²€
# 2) ê²°ì¸¡ì¹˜ ì²˜ë¦¬ / íƒ€ìž… ë³€í™˜
# 3) ì§€í‘œ ê³„ì‚°: ì¼ê°„ìˆ˜ìµë¥ , ëˆ„ì ìˆ˜ìµë¥ , ì´ë™í‰ê· ì„ (SMA20/50)
# 4) ì›”ê°„ ë¦¬ìƒ˜í”Œë§(í‰ê·  ì¢…ê°€, ì´ ê±°ëž˜ëŸ‰)
# 5) ê°„ë‹¨í•œ ë§¤ìˆ˜/ë§¤ë„ ì‹œê·¸ë„(ê³¨ë“ /ë°ë“œ í¬ë¡œìŠ¤)
# 6) ì‹œê°í™”(ê°€ê²©+ì´ë™í‰ê· , ìˆ˜ìµë¥  ížˆìŠ¤í† ê·¸ëž¨)
# 7) ê°€ê³µ ê²°ê³¼ CSVë¡œ ì €ìž¥

# Airbnbã®æ ªä¾¡CSVã§pandasã‚’å®Ÿè·µã™ã‚‹ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# æ©Ÿèƒ½:
# 1) CSVã®èª­ã¿è¾¼ã¿ã¨ç‚¹æ¤œ
# 2) æ¬ æå€¤ã®å‡¦ç† / åž‹å¤‰æ›
# 3) æŒ‡æ¨™ã®è¨ˆç®—: æ—¥æ¬¡åŽç›ŠçŽ‡ã€ç´¯ç©åŽç›ŠçŽ‡ã€ç§»å‹•å¹³å‡ç·š(SMA20/50)
# 4) æœˆé–“ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°(å¹³å‡çµ‚å€¤ã€ç·å–å¼•é‡)
# 5) ç°¡å˜ãªè²·ã„/å£²ã‚Šã‚·ã‚°ãƒŠãƒ«(ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³/ãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹)
# 6) è¦–è¦šåŒ–(ä¾¡æ ¼+ç§»å‹•å¹³å‡ã€åŽç›ŠçŽ‡ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ )
# 7) åŠ å·¥çµæžœã‚’CSVã§ä¿å­˜

import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px


# ---------------------------
# 1) ë°ì´í„° ë¡œë“œ (Data Loading)
# ---------------------------
# @st.cache ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ë¡œë”©ì„ ìºì‹œí•©ë‹ˆë‹¤.
# ì´ë ‡ê²Œ í•˜ë©´ ì•±ì´ ë‹¤ì‹œ ì‹¤í–‰ë  ë•Œë§ˆë‹¤ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ì—¬ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.
@st.cache
def load_data(path):
    # CSV íŒŒì¼ì„ ì½ì–´ ë°ì´í„°í”„ë ˆìž„ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. 'Date' ì—´ì€ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
    df = pd.read_csv(path, parse_dates=["Date"])
    # ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°í”„ë ˆìž„ì„ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³  ì¸ë±ìŠ¤ë¥¼ ìž¬ì„¤ì •í•©ë‹ˆë‹¤.
    df = df.sort_values("Date").reset_index(drop=True)
    return df

# CSV íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
CSV_PATH = 'datasets/ABNB_stock/ABNB_stock.csv' 
# load_data í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
df = load_data(CSV_PATH)

# ---------------------------
# 2) ì‚¬ì´ë“œë°” (Sidebar)
# ---------------------------
# ì‚¬ì´ë“œë°”ì— í—¤ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
st.sidebar.header("Filter")

# ë‚ ì§œ í•„í„° (Date Filter)
# ë°ì´í„°í”„ë ˆìž„ì—ì„œ ìµœì†Œ ë‚ ì§œì™€ ìµœëŒ€ ë‚ ì§œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
min_date, max_date = df["Date"].min(), df["Date"].max()
# ì‚¬ì´ë“œë°”ì— ë‚ ì§œ ë²”ìœ„ ì„ íƒ ìœ„ì ¯ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
date_range = st.sidebar.date_input(
    "ê¸°ê°„ ì„¤ì •", # ìœ„ì ¯ì˜ ë ˆì´ë¸”
    value=[min_date, max_date], # ê¸°ë³¸ê°’ìœ¼ë¡œ ì „ì²´ ê¸°ê°„ì„ ì„¤ì •
    min_value=min_date, # ì„ íƒ ê°€ëŠ¥í•œ ìµœì†Œ ë‚ ì§œ
    max_value=max_date # ì„ íƒ ê°€ëŠ¥í•œ ìµœëŒ€ ë‚ ì§œ
)
# ì´ë™í‰ê· ì„  ê¸°ê°„ ì„¤ì • (Moving Average Period Setting)
# ë‹¨ê¸° ì´ë™í‰ê· ì„  ê¸°ê°„ì„ ì„¤ì •í•˜ëŠ” ìŠ¬ë¼ì´ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
sma_short = st.sidebar.slider("ë‹¨ê¸° ì´ë™í‰ê·  (ì¼)", 5, 50, 20)      # ìµœì†Œ 5, ìµœëŒ€ 50, ê¸°ë³¸ê°’ 20
# ìž¥ê¸° ì´ë™í‰ê· ì„  ê¸°ê°„ì„ ì„¤ì •í•˜ëŠ” ìŠ¬ë¼ì´ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
sma_long = st.sidebar.slider("ìž¥ê¸° ì´ë™í‰ê·  (ì¼)", 50, 200, 100)    # ìµœì†Œ 50, ìµœëŒ€ 200, ê¸°ë³¸ê°’ 100

# ---------------------------
# 3) ë°ì´í„° ì „ì²˜ë¦¬ (Data Preprocessing)
# ---------------------------

# ì‚¬ìš©ìžê°€ ì„ íƒí•œ ë‚ ì§œ ë²”ìœ„ì— ë”°ë¼ ë°ì´í„°ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
mask = (df["Date"] >= pd.to_datetime(date_range[0])) & (df["Date"] <= pd.to_datetime(date_range[1]))
df_filtered = df.loc[mask].copy()

# ì´ë™í‰ê· ì„  ê³„ì‚° (Calculate Moving Averages)
# ë‹¨ê¸° ì´ë™í‰ê· ì„ ì„ ê³„ì‚°í•˜ì—¬ 'SMA_short' ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
df_filtered["SMA_short"] = df_filtered["Close"].rolling(window=sma_short).mean()
# ìž¥ê¸° ì´ë™í‰ê· ì„ ì„ ê³„ì‚°í•˜ì—¬ 'SMA_long' ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
df_filtered["SMA_long"] = df_filtered["Close"].rolling(window=sma_long).mean()

# ìˆ˜ìµë¥  ê³„ì‚° (Calculate Returns)
# ì¼ì¼ ìˆ˜ìµë¥ ì„ ê³„ì‚°í•˜ì—¬ 'Return' ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
df_filtered["Return"] = df_filtered["Close"].pct_change()
# ëˆ„ì  ìˆ˜ìµë¥ ì„ ê³„ì‚°í•˜ì—¬ 'CumReturn' ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. fillna(0)ìœ¼ë¡œ ì²« ë‚ ì˜ NaN ê°’ì„ 0ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
df_filtered["CumReturn"] = (1 + df_filtered["Return"].fillna(0)).cumprod()

# ---------------------------
# 4) ë©”ì¸ íŽ˜ì´ì§€
# ---------------------------
st.title("ðŸ“Š Airbnb Stock Dashboard")

st.markdown("""
Airbnb (`ABNB`) æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æžã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰  
ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ **æœŸé–“**ã¨ **ç§»å‹•å¹³å‡ç·š**ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
""")

st.divider()


# ---------------------------
# 5) ê°€ê²© ì°¨íŠ¸ (ì´ë™í‰ê·  í¬í•¨)
# ---------------------------
st.subheader("æ ªä¾¡ ç§»å‹•å¹³å‡ç·š")
fig_price = px.line(df_filtered, x="Date", y="Close", title="ABNB Closing Price")
fig_price.add_scatter(x=df_filtered["Date"], y=df_filtered["SMA_short"], mode="lines", name=f"SMA{sma_short}")
fig_price.add_scatter(x=df_filtered["Date"], y=df_filtered["SMA_long"], mode="lines", name=f"SMA{sma_long}")
st.plotly_chart(fig_price, use_container_width=True)

# ---------------------------
# 6) ëˆ„ì  ìˆ˜ìµë¥ 
# ---------------------------
st.subheader("ç´¯ç©åŽç›ŠçŽ‡")
st.line_chart(df_filtered.set_index("Date")["CumReturn"])

# ---------------------------
# 7) ìˆ˜ìµë¥  ë¶„í¬
# ---------------------------
st.subheader("æ—¥åŽåˆ†å¸ƒ")
st.bar_chart(df_filtered["Return"].dropna().value_counts(bins=30).sort_index())

# ---------------------------
# 8) ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
# ---------------------------
with st.expander("ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"):
    st.dataframe(df_filtered.head(20))